<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Test Case for 'Window.focus'</title>
    <script>
      var screenWidth = screen.availWidth;
      var gui = require('nw.gui');
      var win = gui.Window.get();
      var win_c = new Array();
      var win2_clicked = false;
      var win1_clicked = false;
      var child_run_flag = false;

      var mainWindowX = screenWidth - window.innerWidth;
      win.moveTo(mainWindowX, 0);


      for (var i = 0; i < 3; i++)
        win_c[i] = 0;
      localStorage.win1 = 0;
      var win1 = gui.Window.open('index1.html', {
        'new-instance': true
      });

      var win2 = gui.Window.open('index2.html');

      win.on('focus', function() {
        console.log('win');
        win_c[0]++;
        if (child_run_flag === true) {
          var buttons = document.getElementsByTagName("button");
          for (var i = 0; i < buttons.length; ++i) {
            var b = buttons[i];
            b.click();
          }
        }
      });

      win2.on('focus', function() {
        console.log('win2');
        win_c[2]++;
        win2_clicked = true;
      });

      function focus1() {
        win1_clicked = true;
        win_c[1] = localStorage.win1;
      }

      function done() {
        if (win1_clicked && win2_clicked) {
          var client = require('../../nw_test_app').createClient({
            argv: gui.App.argv,
            data: win_c
          });
        } else
          setTimeout(done, 2000);
      }

      done();

      setTimeout(function() {
        var clickPositions = ["100,100,1000", (mainWindowX + 100) + "," + 100 + ",3000"];
        var spawn = require('child_process').spawn;
        var child = spawn('java', ['-jar', 'Mouse.jar'].concat(clickPositions));
        child_run_flag = true;
        child.on('exit', function(code, signal) {
          child_run_flag = false;
          console.log(code, signal);
          if (code === 0) {
            focus1();
            setTimeout(function() {
              win2.focus();
            }, 500)
          }
        });
        console.log("Start Java child process");
      }, 1000);
    </script>
  </head>
  <body>
    <p id="wait" style="font-size:1.5em">For now you should manually click the button to test the case</p>
    <button onclick="focus1()">You should click this only after you focused win1</button>
    <button onclick="win2.focus()">win2 Focus</button>
  </body>
</html>
