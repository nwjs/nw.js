<!DOCTYPE html>
<html>

<head>
  <title>TEST CASE FOR COOKIES API</title>
</head>

<body>
  <h1>Hello World!</h1>
  We are using node.js
  <script type="text/javascript">
    var gui = require('nw.gui');
    var win = gui.Window.get(window.open('http://localhost:8125'));
    var results = new Array();
    var changed = false;

    var action = gui.App.argv[0];

    function retrieveAll(domain) {
        win.cookies.getAll({
            "domain": domain
        }, function(cookies) {
            if (!cookies || cookies.length === 0) {
                results.push(false);
            } else {
                result.push(true);
            }
        });
    };

    function remove(url, name) {
        win.cookies.remove({
            'url': url,
            'name': name
        });
    }

    function set(domain, url, name, value) {
        win.cookies.set({
            'url': url,
            'name': name,
            'value': value,
            'expirationDate': 9999999999
        });
    }

    function retrieve(url, name) {
        win.cookies.get({
            "url": url,
            "name": name
        }, function(cookie) {
            if (cookie != null && cookie != undefined) {
                results.push(true);
            } else {
                results.push(false);
            }
        });
    }

    function sendResult() {
        setTimeout(function() {
            var client = require('../../nw_test_app').createClient({
                argv: gui.App.argv,
                data: results
            });
        }, 1000);
    }

    win.cookies.onChanged.addListener(function() {
        changed = true;
    });


    win.window.onload = function() {
        if (action === '1') {
            retrieve("http://localhost:8125/", "lang");
            retrieveAll('localhost:8125');
            results.push(changed);
            win.close();
            sendResult();
        } else if (action === '2') {
            win.close();
            set('localhost', "http://localhost:8125/", "lang", "en");
            win = gui.Window.get(window.open('http://localhost:8125/'));
            win.window.onload = function() {
                var request_cookies = JSON.parse(win.window.document.body.innerText);
                if (request_cookies.lang != "en") {
                    results.push(false);
                } else {
                    results.push(true);
                }
                sendResult();
            };
        } else if (action === '3') {
            win.close();
            set('localhost', "http://localhost:8125/", "lang", "zh");
            win = gui.Window.get(window.open('http://localhost:8125/'));
            win.window.onload = function() {
                var request_cookies = JSON.parse(win.window.document.body.innerText);
                if (request_cookies.lang != "zh") {
                    results.push(false);
                } else {
                    results.push(true);
                }
                win.close();
                sendResult();
            };
        } else if (action === '4') {
            remove("http://localhost:8125","lang");
            results.push(changed);//should be true
            retrieve("http://localhost:8125","lang");//should be false
            sendResult();
        }
    };
  </script>

</body>

</html>